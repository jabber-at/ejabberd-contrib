#!/usr/bin/make -f

BIN_PACKAGES=$(shell grep ^Package: debian/control  | sed 's/^Package: //')
EJABBERDDIR=$(shell basename `find /usr/lib -type d -path "*/ejabberd-[0-9][0-9].[0-9][0-9]"`)

ejabberd-mod-admin-extra_BUILD_PATH=mod_admin_extra/
ejabberd-mod-cron_BUILD_PATH=mod_cron/
ejabberd-mod-log-chat_BUILD_PATH=mod_log_chat/
ejabberd-mod-logxml_BUILD_PATH=mod_logxml/
ejabberd-mod-muc-admin_BUILD_PATH=mod_muc_admin/
ejabberd-mod-muc-log-http_BUILD_PATH=mod_muc_log_http/
ejabberd-mod-register-web_BUILD_PATH=mod_register_web/
ejabberd-mod-rest_BUILD_PATH=mod_rest/
ejabberd-mod-s2s-log_BUILD_PATH=mod_s2s_log/
ejabberd-mod-statsdx_BUILD_PATH=mod_statsdx/
ejabberd-mod-webpresence_BUILD_PATH=mod_webpresence/
ejabberd-mod-logsession_BUILD_PATH=mod_logsession/
ejabberd-mod-auth-http_BUILD_PATH=ejabberd_auth_http/
ejabberd-mod-post-log_BUILD_PATH=mod_post_log/
ejabberd-mod-graphite_BUILD_PATH=mod_grafite/
ejabberd-mod-pottymouth_BUILD_PATH=mod_pottymouth/

%:
	dh $@

build-%:
	rm -f ejabberd-dev/ebin/*.beam
	mkdir -p ${$*_BUILD_PATH}ebin
	cd ${$*_BUILD_PATH} && erlc -o ebin -I include -I /usr/lib/$(EJABBERDDIR)/include \
	    -DLAGER \
	    src/*.erl

override_dh_installchangelogs:
	dh_installchangelogs
	dh_installchangelogs -pejabberd-mod-logxml mod_logxml/ChangeLog
	dh_installchangelogs -pejabberd-mod-s2s-log mod_s2s_log/ChangeLog
	dh_installchangelogs -pejabberd-mod-statsdx mod_statsdx/ChangeLog

override_dh_auto_build: $(BIN_PACKAGES:%=build-%)

update-init-%:
	debian/dh_moduleupdate $*

override_dh_installinit: $(BIN_PACKAGES:%=update-init-%)
	dh_installinit
